{% extends "myapp/base.html" %}

{% block title %}
    {% if estado %}{{ estado.etapa }}{% else %}Subvenciones{% endif %}
{% endblock %}

{% block content %}
{% load tags %}
{% load staticfiles %}
{% load notification_tags %}

{% if notifications %}
    <div class="row">
        <div class="col-md-3 col-lg-3"></div>
        <div class="col-md-6 col-lg-6">
            <div class="card">
                <div class="card-header">
                    Notificaciones
                </div>

                <div class="notification-box-list card-block" style="padding:10px;height:150px;overflow:auto;">
                    {% user_notifications %}
                    {% include_notify_js_variables %}
                </div>
            </div>
        </div>
        <div class="col-md-3 col-lg-3"></div>
    </div>
{% endif %}

<div class="row subv-row-departamentos">
    <div class="col-lg">
        {% for e in estados %}
            <div class="div-dep estadocss" style="background-color:{{ e.font_color }};">
                {{ e.etapa }}
            </div>
        {% endfor %}
    </div>
</div>

<div class="row align-items-center subv-table-row">
    <div class="col-12">
        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                    {{ message }}
                </div>
            {% endfor %}
        {% endif %}

        {% if subvenciones %}
            <table id="subv_table_ordering" class="table table-responsive" width="100%">
                <thead class="thead-subv-table">
                    <tr class="table-active">
                        <th>INICIO</th>
                        <th>DEPARTAMENTO</th>
                        <th>NOMBRE</th>
                        <th>FIN</th>
                        <th>CUANTÍA</th>
                        <th>RESPONSABLES</th>
                        <th>ESTADO</th>
                        <th>COMENTARIOS</th>
						<th>DESCRIPCIÓN</th>
                        <th>GESTIONA</th>
                        <th><i class="fa fa-tasks" aria-hidden="true"></i></th>
                    </tr>
                </thead>

                <tbody>
                    {% for subvencion in subvenciones %}
                        <tr>
                            <td>
                                {{ subvencion.inicio|date:"d/m/Y" }}

                            </td>
                            <td style="background-color:{% if subvencion.generalitat == None %}{{ subvencion.diputacion.font_color }}{% else %}{{ subvencion.generalitat.font_color }}{% endif %};">
                                {% if subvencion.generalitat == None %}
                                    {{ subvencion.diputacion }}
                                {% else %}
                                    {{ subvencion.generalitat }}
                                {% endif %}
                            </td>
                            <td>
                                <a href="{{ subvencion.get_absolute_url }}" target="_blank">
                                    {{ subvencion.nombre|safe }}
                                </a>
                            </td>
                            <td style="{% if subvencion.fin|daysuntil in days_until_estado %}background-color:#ff0000;color:#fff;{% elif subvencion.fin|daysuntil == 'passed days' %}background-color:{{ subvencion.estado.font_color }};{% else %}background-color:#fff;{% endif %}">
                                {{ subvencion.fin|date:"d/m/Y" }}
                            </td>
                            <td>{{ subvencion.cuantia|safe }}</td>
                            <td>
                                {% for responsable in subvencion.responsable.all %}
                                    {{ responsable }}<br>
                                {% endfor %}
                            </td>
                            <td class="estadocss" style="background-color:{{ subvencion.estado.font_color }};">
                                {{ subvencion.estado }}
                            </td>
                            <td tabindex="0" data-toggle="popover" data-trigger="hover" title="Comentarios" data-content="{{ subvencion.comentarios|safe }}">
                                {{ subvencion.comentarios|truncatewords:6|safe }}
                            </td>
							<td tabindex="0" data-toggle="popover" data-trigger="hover" title="Descripción" data-content="{{ subvencion.descripcion|safe }}">
                                {{ subvencion.descripcion|truncatewords:6|safe }}
                            </td>
                            <td>
                                {{ subvencion.gestiona_expediente }}<br>
                                {% if not subvencion.drive %}
                                {% else %}
                                    <a href="{{ subvencion.drive }}" target="_blank">Drive</a>
                                {% endif %}
                            </td>
                            <td>
                                <a href="{% url 'myapp:edit_subvencion' slug=subvencion.slug %}"><i class="fa fa-pencil-square-o" aria-hidden="true"></i></a>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <!-- Paginator -->
            {% if subvenciones.has_other_pages %}
                <ul class="pagination">
                    {% if subvenciones.has_previous %}
                        <li class="page-item"><a class="page-link" href="?page={{ subvenciones.previous_page_number }}">&laquo;</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">&laquo;</span></li>
                    {% endif %}

                    {% for i in subvenciones.paginator.page_range %}
                        {% if subvenciones.number == i %}
                            <li class="page-item active"><a href="#" class="page-link">{{ i }}</a></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ i }}">{{ i }}</a></li>
                        {% endif %}
                    {% endfor %}

                    {% if subvenciones.has_next %}
                        <li class="page-item"><a class="page-link" href="?page={{ subvenciones.next_page_number }}">&raquo;</a></li>
                    {% else %}
                        <li class=" page-item disabled"><span class="page-link">&raquo;</span></li>
                    {% endif %}
                </ul>
            {% endif %}
        {% else %}
            <h2>No hay subvenciones, proceda a insertar <a href="{% url 'myapp:new_subvencion' %}">una.</a></h2>
        {% endif %}
    </div>
</div>

{% endblock %}

{% block js %}
    <script>
        $(document).ready(function() {
            $('[data-toggle="popover"]').popover();
            $('#subv_table_ordering').DataTable({
                "language": {
                    url: "/static/myapp/location/es_ES.json"
                }
            });

            //Notifications script
            $(".notification-box-list .delete-notification").click(function()
            {
                if ($(this).parent().parent().find('div.notification').length == 1)
                {
                    $(this).parent().parent().parent().parent().parent().hide();
                }
            });

            $('.estadocss').each(function() {
                var rgb = $(this).css('backgroundColor');

                var colors = rgb.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/);
                var brightness = 1;

                var r = colors[1];
                var g = colors[2];
                var b = colors[3];

                var ir = Math.floor((255-r)*brightness);
                var ig = Math.floor((255-g)*brightness);
                var ib = Math.floor((255-b)*brightness);

                $(this).css('color', 'rgb('+ir+','+ig+','+ib+')');
            });
        });
    </script>
    <script src="{% static 'notify/notifyX.js' %}"></script>
{% endblock %}

