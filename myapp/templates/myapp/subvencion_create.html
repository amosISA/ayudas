{% extends "myapp/base.html" %}

{% block title %}
    {% if request.path != '/new/' %}
        Subs: {{ subvencion.nombre }}
    {% else %}
        Crear
    {% endif %}
{% endblock %}

{% block navbar %}
    {% include 'myapp/navbar.html' %}
{% endblock %}

{% block content %}

    {% load staticfiles %}
    {% load tags %}
    <div class="row forms_act_crea">
        <div class="ag_create_post_wrapper col-lg-12">
            {% if request.path == '/new/' %}
                <h1 class="h1">Añadir Subvención</h1>
            {% else %}
                <h1 class="h1">Editar Subvención</h1>
            {% endif %}

            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-{{ message.tags }}">
                        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        {{ message }}
                    </div>
                {% endfor %}
            {% endif %}

            <form id="some-form" class="form-horizontal" method="post" enctype="multipart/form-data" action="">{% csrf_token %}

                {% if form.errors %}
                    <div class="ag_form_login_message_error">
                        {% for field,error in form.errors.items %}
                            {{ field|capfirst }} - {{ error|striptags }}
                        {% endfor %}
                    </div>
                {% endif %}

                <div class="row">
                    <div class="col-lg-3 doted-right">
                        <div class="row">
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Inicio -->
                                {{ form.inicio.label_tag }}
                                {{ form.inicio|htmlattributes:"class:form-control" }}
                            </div>
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Fin -->
                                {{ form.fin.label_tag }}
                                {{ form.fin|htmlattributes:"class:form-control" }}
                            </div>
                        </div>

                        <!-- Responsable -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.responsable.label_tag }}
                            {{ form.responsable|htmlattributes:"class:form-control" }}
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Gestiona Enlace -->
                                {{ form.drive.label_tag }}
                                {{ form.drive|htmlattributes:"class:form-control" }}
                            </div>
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Gestiona Expediente -->
                                {{ form.gestiona_expediente.label_tag }}
                                {{ form.gestiona_expediente|htmlattributes:"placeholder: Expediente, class:form-control" }}
                            </div>
                        </div>

                        <!-- Nombre carpeta drive -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.nombre_carpeta_drive.label_tag }}
                            {{ form.nombre_carpeta_drive|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Ente -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            <label for="id_ente">Departamento:</label>
                            {{ form.ente|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Diputacion -->
                        <div class="title-create_post field-diputacion">
                            {{ form.diputacion|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Generalitat -->
                        <div class="title-create_post field-generalitat">
                            {{ form.generalitat|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Gobierno -->
                        <div class="title-create_post field-gobierno">
                            {{ form.gobierno|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Colectivo -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.colectivo.label_tag }}
                            {{ form.colectivo|htmlattributes:"class:form-control" }}
                        </div>

                        <!-- Estado -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.estado.label_tag }}
                            {{ form.estado|htmlattributes:"class:form-control" }}
                        </div>

                        <div class="row">
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Cuantia inicio -->
                                <label for="id_cuantia">Cuantía inicio:</label>
                                {{ form.cuantia|htmlattributes:"class:form-control" }}
                            </div>
                            <div class="form-group col-md-6 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Cuantia final -->
                                {{ form.cuantia_final.label_tag }}
                                {{ form.cuantia_final|htmlattributes:"class:form-control" }}
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6 doted-right">
                        <!-- Nombre -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.nombre.label_tag }}
                            {{ form.nombre|htmlattributes:"class:form-control" }}
                        </div>

                        <div class="row">
                            <div class="form-group col-md-4 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Procedimiento -->
                                {{ form.procedimiento.label_tag }}
                                {{ form.procedimiento|htmlattributes:"placeholder: Procedimiento, class:form-control" }}
                            </div>
                            <div class="form-group col-md-4 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Bases -->
                                {{ form.bases.label_tag }}
                                {{ form.bases|htmlattributes:"placeholder: Bases, class:form-control" }}
                            </div>
                            <div class="form-group col-md-4 title-create_post" style="text-align:justify;font-weight:bold;">
                                <!-- Solicitud -->
                                <label for="id_solicitud">Solicitud:</label>
                                {{ form.solicitud|htmlattributes:"placeholder: Solicitud, class:form-control" }}
                            </div>
                        </div>

                        <!-- Descripcion -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.descripcion.label_tag }}
                            {{ form.descripcion|htmlattributes:"placeholder: Descripcion, class:form-control" }}
                        </div>

                        <!-- Comentarios -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            {{ form.comentarios.label_tag }}
                            {{ form.comentarios|htmlattributes:"placeholder: Comentarios, class:form-control" }}
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <!-- Ajax filter -->
                        <div class="form-group title-create_post" style="text-align:justify;font-weight:bold;">
                            <label>Subvenciones relacionadas:</label><br>
                            <a class="ajax_relation_anchor" data-toggle="modal" data-target="#ajaxRelationFilterModal" href="{% url 'myapp:ajax_loop_departments' %}">Filtrar</a>
                        </div>
                        <!-- Se relacion con -->
                        <div class="form-group title-create_post se_relaciona_con_ajax_div" style="text-align:justify;font-weight:bold;">
                            {{ form.se_relaciona_con.label_tag }}
                            {{ form.se_relaciona_con|htmlattributes:"placeholder: Expediente, class:form-control" }}
                        </div>
                    </div>
                </div>

                {% if request.path == '/new/' %}
                    <!--onclick="this.disabled=true,this.form.submit();"-->
                    <input class="button_submit_create_form" type="submit" value="Crear Subvención" />
                {% else %}
                    <input class="button_submit_create_form" type="submit" value="Actualizar Subvención" />
                {% endif %}
            </form>

            <!-- Modal -->
            <div class="modal fade" id="ajaxRelationFilterModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="exampleModalLabel">Filtrar por departamentos</h5>
                            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                <span aria-hidden="true">&times;</span>
                            </button>
                        </div>
                        <div class="modal-body">
                        </div>
                        <div class="modal-footer">
                            <button id="modal_ajax_button_filter_subsidies" type="button" class="btn btn-default" data-dismiss="modal">Filtrar</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col" style="display:none;">
            {% if request.path != '/new/' %}
                <a style="margin-top:20px;" href="{% url 'myapp:delete_subvencion' slug=subvencion.slug %}">Eliminar subvención</a>
            {% endif %}
        </div>

    </div>
{% endblock %}

{% block js %}
    <script>
        var $j = jQuery.noConflict();
        window.onload = function(e){
            var ente = document.getElementById("id_ente");
            ente.addEventListener("change", myFunction);

            function myFunction() {
                var ente_value = ente.options[ente.selectedIndex].value;
                var diputacion = document.getElementsByClassName('field-diputacion');
                var generalitat = document.getElementsByClassName('field-generalitat');
                var gobierno = document.getElementsByClassName('field-gobierno');

                if(ente_value == 'DA') {
                   for (var i=0; i<generalitat.length; i+=1){
                      generalitat[i].style.display = 'none';
                      document.getElementById("id_generalitat").selectedIndex = 0;
                   }
                   for (var i=0; i<gobierno.length; i+=1){
                      gobierno[i].style.display = 'none';
                      document.getElementById("id_gobierno").selectedIndex = 0;
                   }
                   for (var i=0; i<diputacion.length; i+=1){
                      diputacion[i].style.display = 'block';
                      document.getElementById("id_diputacion").selectedIndex = 0;
                   }
                   $j('#add_id_diputacion').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                   $j('#add_id_generalitat').css('display', 'none');
                   $j('#add_id_gobierno').css('display', 'none');
                } else if (ente_value == 'GV') {
                    for (var i=0; i<diputacion.length; i+=1){
                      diputacion[i].style.display = 'none';
                      document.getElementById("id_diputacion").selectedIndex = 0;
                    }
                    for (var i=0; i<gobierno.length; i+=1){
                      gobierno[i].style.display = 'none';
                      document.getElementById("id_gobierno").selectedIndex = 0;
                    }
                    for (var i=0; i<generalitat.length; i+=1){
                      generalitat[i].style.display = 'block';
                      document.getElementById("id_generalitat").selectedIndex = 0;
                    }
                    $j('#add_id_generalitat').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                    $j('#add_id_diputacion').css('display', 'none');
                    $j('#add_id_gobierno').css('display', 'none');
                } else if (ente_value == 'GE') {
                    for (var i=0; i<diputacion.length; i+=1){
                      diputacion[i].style.display = 'none';
                      document.getElementById("id_diputacion").selectedIndex = 0;
                    }
                    for (var i=0; i<generalitat.length; i+=1){
                      generalitat[i].style.display = 'none';
                      document.getElementById("id_generalitat").selectedIndex = 0;
                    }
                    for (var i=0; i<gobierno.length; i+=1){
                      gobierno[i].style.display = 'block';
                      document.getElementById("id_gobierno").selectedIndex = 0;
                    }
                    $j('#add_id_gobierno').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                    $j('#add_id_generalitat').css('display', 'none');
                    $j('#add_id_diputacion').css('display', 'none');
                }
            }

            if(ente.options[ente.selectedIndex].value == 'DA') {
                for (var i=0; i<document.getElementsByClassName('field-generalitat').length; i+=1){
                  document.getElementsByClassName('field-generalitat')[i].style.display = 'none';
                }
                for (var i=0; i<document.getElementsByClassName('field-gobierno').length; i+=1){
                  document.getElementsByClassName('field-gobierno')[i].style.display = 'none';
                }
                $j('#add_id_diputacion').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                $j('#add_id_generalitat').css('display', 'none');
                $j('#add_id_gobierno').css('display', 'none');
            } else if (ente.options[ente.selectedIndex].value == 'GV') {
                for (var i=0; i<document.getElementsByClassName('field-diputacion').length; i+=1){
                  document.getElementsByClassName('field-diputacion')[i].style.display = 'none';
                }
                for (var i=0; i<document.getElementsByClassName('field-gobierno').length; i+=1){
                  document.getElementsByClassName('field-gobierno')[i].style.display = 'none';
                }
                $j('#add_id_generalitat').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                $j('#add_id_diputacion').css('display', 'none');
                $j('#add_id_gobierno').css('display', 'none');
            } else if (ente.options[ente.selectedIndex].value == 'GE') {
                for (var i=0; i<document.getElementsByClassName('field-diputacion').length; i+=1){
                  document.getElementsByClassName('field-diputacion')[i].style.display = 'none';
                }
                for (var i=0; i<document.getElementsByClassName('field-generalitat').length; i+=1){
                  document.getElementsByClassName('field-generalitat')[i].style.display = 'none';
                }
                $j('#add_id_gobierno').css('display', 'block').insertAfter($j('label[for="id_ente"]'));
                $j('#add_id_diputacion').css('display', 'none');
                $j('#add_id_generalitat').css('display', 'none');
            }

            // Convert input text inicio and fin into datepickers!!!
            //$j("#id_inicio, #id_fin").multiDatesPicker();

            // Change textarea cols
            $j("textarea[name='drive'], textarea[name='procedimiento'], textarea[name='bases'], textarea[name='solicitud'], textarea[name='nombre']").attr({'cols': '20', 'rows': '1'});
            $j("textarea[name='descripcion']").attr({'cols': '20', 'rows': '12'});
            $j("textarea[name='comentarios']").attr({'cols': '20', 'rows': '12'});
            $j("textarea[name='cuantia']").attr({'cols': '20', 'rows': '1'});
            $j("textarea[name='cuantia_final']").attr({'cols': '20', 'rows': '1'});
            $j("textarea[name='nombre_carpeta_drive']").attr({'cols': '20', 'rows': '1'});

            // Admin plus
            /*$j('.related-widget-wrapper .related-widget-wrapper-link').each(function() {
                $j(this).insertBefore($j(this).parent());
            });*/
            $j('#add_id_estado').insertAfter($j('label[for="id_estado"]'));
            $j('#add_id_responsable').insertAfter($j('label[for="id_responsable"]'));
            //$j('#add_id_diputacion').wrap("<div class='input-group title-create_post smalls_for_departments'><small id='selectDepartamentoDiputacion' class='form-text text-muted'>Añadir departamento Diputación </small></div>");
            //$j('#add_id_generalitat').wrap("<div class='input-group title-create_post smalls_for_departments'><small id='selectDepartamentoGeneralitat' class='form-text text-muted'>Añadir departamento Generalitat </small></div>");

            // add class to select because they lose class with admin functionality
            $j("form:first select").removeClass("form-control").addClass("form-control");

            // select multiple fix height with size
            //$j("select#id_responsable").attr('size', '10');
            //$j("select#id_se_relaciona_con").attr('size', '10');
            //var select_resp = document.getElementById('id_responsable');
            //var select_relac = document.getElementById('id_se_relaciona_con');
            //select_resp.size = select_resp.length;
            //select_relac.size = select_relac.length;

            //quit checkbox attr formcontrol
            $j("#id_se_relaciona_con li label input, #id_responsable li label input, #id_colectivo li label input").removeClass("form-control");

            /* Date bussiness days 30, 25, 10 */
            var id_date_inicio = $j('#id_inicio');
            var id_date_fin = $j('#id_fin');
            var content_div_fin = '<div class="id_date_fin_anchors_bussines_day"><a href="#" onClick="businessDays(15);">+ 15 días hábiles</a><a href="#" onClick="businessDays(20);">+ 20 días hábiles</a><a href="#" onClick="businessDays(30);">+ 30 días hábiles</a></div>'

            id_date_inicio.change(function() {
                if (id_date_inicio.val()) {
                    if (!$j('.id_date_fin_anchors_bussines_day').length) {
                        id_date_fin.after(content_div_fin);
                    }
                } else {
                    console.log('error');
                    $j('.id_date_fin_anchors_bussines_day').remove();
                }
            });
        };

        function businessDays(days) {
            /*var data = {
                "ano_nuevo": "01/01/2018",
                "reyes": "06/01/2018",
                "pascua": "2018/03/30",
                "dia_del_trabajo": "01/05/2018",
                "asuncion_virgen": "2018/08/15",
                "hispanidad": "12/08/2018",
                "santos": "01/11/2018",
                "constitucion": "06/12/2018",
                "inmaculada": "08/12/2018",
                "navidad": "2018/12/25"
            };

            var items = [];
            $j.each( data, function( key, val ) {
                items.push(new Date(val));
            });

            var national_days = [];
            $j.each(items, function(key, value) {
                national_days.push(value.toString().split(" ", 4).join(" "));
            });
            console.log(national_days);*/

            var dataAvui = new Date($j('#id_inicio').val());
            for (var i=1;i<=days;i++)
            {
                var dataTemp = dataAvui;
                var dataFormated = ('0' + dataTemp.getDate()).slice(-2)+"/"+('0'+(dataTemp.getMonth()+1)).slice(-2)+"/"+dataTemp.getFullYear();
                //console.log(dataTemp.toString());
                dataTemp.setDate(dataTemp.getDate() + 1);
                if(dataTemp.getDay() == 6){
                    dataTemp.setDate(dataTemp.getDate() + 2);
                }else if(dataTemp.getDay() == 0){
                    dataTemp.setDate(dataTemp.getDate() + 1);
                }else if(dataFormated == '01/01/2018' || dataFormated == '06/01/2018' || dataFormated == '30/03/2018'
                        || dataFormated == '01/05/2018' || dataFormated == '15/08/2018' || dataFormated == '12/08/2018'
                        || dataFormated == '01/11/2018' || dataFormated == '06/12/2018' || dataFormated == '08/12/2018'
                        || dataFormated == '25/12/2018' || dataFormated == '01/01/2019' || dataFormated == '06/01/2019'
                        || dataFormated == '19/04/2019' || dataFormated == '01/05/2019' || dataFormated == '15/08/2019'
                        || dataFormated == '12/10/2019' || dataFormated == '01/11/2019' || dataFormated == '06/12/2019'
                        || dataFormated == '25/12/2019') {
                    dataTemp.setDate(dataTemp.getDate() + 1);
                }/*else if($j.inArray(dataTemp.toString().split(" ", 4).join(" "), national_days) != -1 && dataTemp.getDay() != 0 && dataTemp.getDay() != 6) {
                    console.log("fecha_calend " + dataTemp.toString().split(" ", 4).join(" ") + " fecha_nacional " + national_days[i]);
                }*/
                //console.log(dataFormated);

                dataAvui = dataTemp;
                $j("#id_fin").val(dataAvui.toInputFormat());
            }
        }

        Date.prototype.toInputFormat = function() {
           var yyyy = this.getFullYear().toString();
           var mm = (this.getMonth()+1).toString(); // getMonth() is zero-based
           var dd  = this.getDate().toString();
           return yyyy + "-" + (mm[1]?mm:"0"+mm[0]) + "-" + (dd[1]?dd:"0"+dd[0]); // padding
        };

        // Make estado and ayuntamiento selected by default
        $j('#id_estado option[value="4"]').attr("selected",true);
        $j('#id_colectivo_1').prop('checked', true);

        // Unsaved changes leaving page
        var form = $j('#some-form'),
        original = form.serialize();

        form.submit(function(){
            window.onbeforeunload = null
        });

        window.onbeforeunload = function(){
            if (form.serialize() != original)
                return 'Are you sure you want to leave?'
        };
    </script>

    {% if request.path != '/new/' %}
        <script>
            // WHEN EDIT SUBSIDIE
            $j(document).ready(function() {
                // AJAX FOR SELECT DEPARTMENT AND FILL SE RELACIONA CON
                $j('ul#id_se_relaciona_con input:checkbox').each(function() {
                    var checkbox = $j(this);
                    if(checkbox.is(':checked')){}else{checkbox.parent().remove();}
                });

                $j('.ajax_relation_anchor').on('click', function(e){
                    e.preventDefault();
                    $j('#ajaxRelationFilterModal').modal('show').find('.modal-body').load($j(this).attr('href'));
                });

                // When you click on each checkbox on the modal and displays the subsidies in the
                // same modal when you check them
                $j('body').on('click', '.modal-ajax-entes input:checkbox', function(){
                    var checkbox = $j(this);
                    var dip_list = [];
                    var gene_list = [];
                    var gob_list = [];

                    if(checkbox.is(':checked')){
                        $j("input[name='diputacion_ajax']:checked").each( function () {
                            dip_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='generalitat_ajax']:checked").each( function () {
                           gene_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='gobierno_ajax']:checked").each( function () {
                           gob_list.push(parseInt($j(this).val()));
                        });

                        $j.ajax({
                            method: 'GET',
                            url: '{% url "myapp:ajax_se_relaciona_con" %}',
                            data: {
                                'diputacion_ajax': dip_list,
                                'generalitat_ajax': gene_list,
                                'gobierno_ajax': gob_list
                            },
                            dataType: 'json',
                            success: function (data) {
                                var checkboxes_list = $j('ul#content_ajax_list input:checkbox');

                                // if the checkboxes in the list are not checked they are deleted when a new checkbox is selected
                                checkboxes_list.each(function() {
                                    var checkbox_list = $j(this);
                                    if(checkbox_list.is(':checked')){}else{checkbox_list.parent().parent().remove();}
                                });

                                $j.each(data, function(key, value){
                                    $j('ul#content_ajax_list').append("<li><label><input type='checkbox' name='se_relaciona_con' value='"+value.pk+"' class='' id='id_se_relaciona_con_"+key+"'>"+value.fields['nombre']+"</label></li>");
                                });

                                // Aquí cuando seleccionas una subvención para que no vuelva a aparecer duplicada la q
                                // has seleccionado, la eliminamos si ya se encuentra dentro del objecto
                                // primero la metemos y luego miramos otra vez si está, y si así es, la eliminamos
                                var inputs_checkbox = {};
                                $j('ul#content_ajax_list input:checkbox').each(function() {
                                    var checkbox = $j(this).val();
                                    if(inputs_checkbox[checkbox]) {
                                        $j(this).parent().parent().remove();
                                    } else {
                                        inputs_checkbox[checkbox] = true;
                                    }
                                });
                            }
                        });
                    } else {
                        dip_list = [], gene_list = [], gob_list = [];

                        $j("input[name='diputacion_ajax']:checked").each( function () {
                            dip_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='generalitat_ajax']:checked").each( function () {
                           gene_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='gobierno_ajax']:checked").each( function () {
                           gob_list.push(parseInt($j(this).val()));
                        });

                        $j.ajax({
                            method: 'GET',
                            url: '{% url "myapp:ajax_se_relaciona_con" %}',
                            data: {
                                'diputacion_ajax': dip_list,
                                'generalitat_ajax': gene_list,
                                'gobierno_ajax': gob_list
                            },
                            dataType: 'json',
                            success: function (data) {
                                var checkboxes_list = $j('ul#content_ajax_list input:checkbox');

                                checkboxes_list.each(function() {
                                    var checkbox_list = $j(this);
                                    if(checkbox_list.is(':checked')){}else{checkbox_list.parent().parent().remove();}
                                });

                                $j.each(data, function(key, value){
                                    $j('ul#content_ajax_list').append("<li><label><input type='checkbox' name='se_relaciona_con' value='"+value.pk+"' class='' id='id_se_relaciona_con_"+key+"'>"+value.fields['nombre']+"</label></li>");
                                });
                            }
                        });
                    }
                });

                // When you click on filter button from the modal popup
                $j('#modal_ajax_button_filter_subsidies').click(function() {
                    $j('.se_relaciona_con_ajax_div').css('display', 'block');
                    var ul_li = $j('#id_se_relaciona_con');
                    ul_li.text('');

                    $j('ul#content_ajax_list input:checkbox').each(function() {
                        if($j(this).is(':checked')){
                            ul_li.append('<li>'+$j(this).parent().parent().html()+'</li>');
                        }
                    });
                    $j('#id_se_relaciona_con input:checkbox').prop('checked', true);
                });

                // AJAX FOR LIKES
                $j('a.like-button-details').click(function(e) {
                    e.preventDefault();
                    $j.post('{% url "myapp:like" %}',
                        {
                            id: $j(this).data('id'),
                            action: $j(this).data('action')
                        },
                        function(data) {
                            if(data['status'] == 'ok')
                            {
                                var button_likes = $j('a.like-button-details');
                                var previous_action = button_likes.data('action');
                                //toggle data-action
                                button_likes.data('action', previous_action == 'like' ? 'unlike' : 'like');
                                //toggle link text
                                $j('.likes_heart').addClass(previous_action == 'like' ? $j('.likes_heart').addClass("fas") : $j('.likes_heart').removeClass('fas'));
                            }
                        }
                    );
                });
            });
        </script>
    {% else %}
        <script>
            // Frist, empty the ul
            $j('ul#id_se_relaciona_con').text('');

            // WHEN ADD SUBSIDIE
            $j(document).ready(function() {
                // AJAX FOR SELECT DEPARTMENT AND FILL SE RELACIONA CON
                $j('.se_relaciona_con_ajax_div').css('display', 'none');

                // When you click the first filter button and modal appear
                $j('.ajax_relation_anchor').on('click', function(e){
                    // Made the popup appear with the insert template
                    e.preventDefault();
                    $j('#ajaxRelationFilterModal').modal('show').find('.modal-body').load($j(this).attr('href'));
                });

                // When you click on each checkbox on the modal and displays the subsidies in the
                // same modal when you check them
                $j('body').on('click', '.modal-ajax-entes input:checkbox', function(){
                    var checkbox = $j(this);
                    var dip_list = [];
                    var gene_list = [];
                    var gob_list = [];

                    if(checkbox.is(':checked')){
                        $j("input[name='diputacion_ajax']:checked").each( function () {
                            dip_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='generalitat_ajax']:checked").each( function () {
                           gene_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='gobierno_ajax']:checked").each( function () {
                           gob_list.push(parseInt($j(this).val()));
                        });

                        $j.ajax({
                            method: 'GET',
                            url: '{% url "myapp:ajax_se_relaciona_con" %}',
                            data: {
                                'diputacion_ajax': dip_list,
                                'generalitat_ajax': gene_list,
                                'gobierno_ajax': gob_list
                            },
                            dataType: 'json',
                            success: function (data) {
                                var checkboxes_list = $j('ul#content_ajax_list input:checkbox');

                                // if the checkboxes in the list are not checked they are deleted when a new checkbox is selected
                                checkboxes_list.each(function() {
                                    var checkbox_list = $j(this);
                                    if(checkbox_list.is(':checked')){}else{checkbox_list.parent().parent().remove();}
                                });

                                $j.each(data, function(key, value){
                                    $j('ul#content_ajax_list').append("<li><label><input type='checkbox' name='se_relaciona_con' value='"+value.pk+"' class='' id='id_se_relaciona_con_"+key+"'>"+value.fields['nombre']+"</label></li>");
                                });

                                // Aquí cuando seleccionas una subvención para que no vuelva a aparecer duplicada la q
                                // has seleccionado, la eliminamos si ya se encuentra dentro del objecto
                                // primero la metemos y luego miramos otra vez si está, y si así es, la eliminamos
                                var inputs_checkbox = {};
                                $j('ul#content_ajax_list input:checkbox').each(function() {
                                    var checkbox = $j(this).val();
                                    if(inputs_checkbox[checkbox]) {
                                        $j(this).parent().parent().remove();
                                    } else {
                                        inputs_checkbox[checkbox] = true;
                                    }
                                });
                            }
                        });
                    } else {
                        dip_list = [], gene_list = [], gob_list = [];

                        $j("input[name='diputacion_ajax']:checked").each( function () {
                            dip_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='generalitat_ajax']:checked").each( function () {
                           gene_list.push(parseInt($j(this).val()));
                        });
                        $j("input[name='gobierno_ajax']:checked").each( function () {
                           gob_list.push(parseInt($j(this).val()));
                        });

                        $j.ajax({
                            method: 'GET',
                            url: '{% url "myapp:ajax_se_relaciona_con" %}',
                            data: {
                                'diputacion_ajax': dip_list,
                                'generalitat_ajax': gene_list,
                                'gobierno_ajax': gob_list
                            },
                            dataType: 'json',
                            success: function (data) {
                                var checkboxes_list = $j('ul#content_ajax_list input:checkbox');

                                checkboxes_list.each(function() {
                                    var checkbox_list = $j(this);
                                    if(checkbox_list.is(':checked')){}else{checkbox_list.parent().parent().remove();}
                                });

                                $j.each(data, function(key, value){
                                    $j('ul#content_ajax_list').append("<li><label><input type='checkbox' name='se_relaciona_con' value='"+value.pk+"' class='' id='id_se_relaciona_con_"+key+"'>"+value.fields['nombre']+"</label></li>");
                                });
                            }
                        });
                    }
                });

                // When you click on filter button from the modal popup
                $j('#modal_ajax_button_filter_subsidies').click(function() {
                    $j('.se_relaciona_con_ajax_div').css('display', 'block');
                    var ul_li = $j('#id_se_relaciona_con');
                    ul_li.text('');

                    $j('ul#content_ajax_list input:checkbox').each(function() {
                        if($j(this).is(':checked')){
                            ul_li.append('<li>'+$j(this).parent().parent().html()+'</li>');
                        }
                    });
                    $j('#id_se_relaciona_con input:checkbox').prop('checked', true);
                });
            });
        </script>
    {% endif %}

    <!-- For the admin site -->
    <script type="text/javascript" src="/static/admin/js/jquery.init.js"></script>
    <script src="{% static 'admin/js/core.js' %}"></script>
    <script src="{% static 'admin/js/admin/RelatedObjectLookups.js' %}"></script>
    <!--Tinymce Text-Editor -->
    <script src="{% static 'myapp/js/tinymce/tinymce.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'myapp/js/tinymce/custom.js' %}" ></script>
{% endblock %}